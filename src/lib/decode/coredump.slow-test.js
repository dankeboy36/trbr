// @ts-check

import path from 'node:path'
import url from 'node:url'

import { FQBN } from 'fqbn'
import { beforeAll, beforeEach, describe, expect, inject, it, vi } from 'vitest'

import { findToolPath } from '../tool.js'
import { decodeCoredump } from './coredump.js'
import { isRiscvFQBN } from './riscv.js'

// @ts-ignore
const __dirname = path.dirname(url.fileURLToPath(import.meta.url))
const coredumpsPath = path.join(
  __dirname,
  '..',
  '..',
  '..',
  '.tests',
  'coredumps'
)

/**
 * @typedef {Object} DecodeCoredumpTestParams
 * @property {string} coredumpFolderName
 * @property {string} fqbn
 * @property {import('./coredump.js').CoredumpDecodeResult} expected
 */

/** @type {DecodeCoredumpTestParams[]} */
const decodeCoredumpTestParams = [
  {
    coredumpFolderName: 'crash_test',
    fqbn: 'esp32:esp32:esp32c3',
    expected: [
      {
        threadId: '1',
        TCB: 1070158756,
        current: true,
        result: {
          faultInfo: {
            coreId: 1,
            programCounter: {
              addr: 1107296384,
              location: {
                regAddr: '0x42000080',
                lineNumber: '12',
                method: 'setup',
                file: 'src/main.cpp',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            zero: 0,
            ra: 1107296384,
            sp: 1070158672,
            gp: 1070119424,
            tp: 1070115796,
            t0: 1074104590,
            t1: 1077439454,
            t2: 0,
            fp: 1070125056,
            s1: 1070129152,
            a0: 1,
            a1: 1,
            a2: 0,
            a3: 1,
            a4: 1611399168,
            a5: 0,
            a6: 3773952000,
            a7: 28,
            s2: 0,
            s3: 0,
            s4: 0,
            s5: 0,
            s6: 0,
            s7: 0,
            s8: 0,
            s9: 0,
            s10: 0,
            s11: 0,
            t3: 0,
            t4: 0,
            t5: 0,
            t6: 0,
            pc: 1107296384,
          },
          stacktraceLines: [
            {
              regAddr: '0x42000080',
              lineNumber: '12',
              method: 'setup',
              file: 'src/main.cpp',
              args: [],
            },
            {
              regAddr: '0x420022cc',
              lineNumber: '42',
              method: 'loopTask',
              file: '/Users/kittaakos/.platformio/packages/framework-arduinoespressif32/cores/esp32/main.cpp',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x4038729c',
              lineNumber: '133',
              method: 'prvTaskExitError',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/riscv/port.c',
              args: [],
            },
          ],
        },
      },
      {
        threadId: '2',
        current: false,
        TCB: 1070148828,
        result: {
          faultInfo: {
            coreId: 2,
            programCounter: {
              addr: 1107370808,
              location: {
                regAddr: '0x42012338',
                lineNumber: '855',
                method: 'esp_pm_impl_waiti',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            zero: 0,
            ra: 1077436114,
            sp: 1070148736,
            gp: 1070119424,
            tp: 1070105860,
            t0: 0,
            t1: 0,
            t2: 0,
            fp: 1070146152,
            s1: 1070130928,
            a0: 1,
            a1: 1070146144,
            a2: 1070146144,
            a3: 64,
            a4: 1070130884,
            a5: 0,
            a6: 0,
            a7: 0,
            s2: 1070128468,
            s3: 2147483647,
            s4: 1070128476,
            s5: 1070129152,
            s6: 0,
            s7: 0,
            s8: 0,
            s9: 0,
            s10: 0,
            s11: 0,
            t3: 0,
            t4: 0,
            t5: 0,
            t6: 0,
            pc: 1107370808,
          },
          stacktraceLines: [
            {
              regAddr: '0x42012338',
              lineNumber: '855',
              method: 'esp_pm_impl_waiti',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
              args: [],
            },
            {
              regAddr: '0x4200b352',
              lineNumber: '63',
              method: 'esp_vApplicationIdleHook',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/freertos_hooks.c',
              args: [],
            },
            {
              regAddr: '0x40385ed2',
              lineNumber: '4099',
              method: 'prvIdleTask',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x4038729c',
              lineNumber: '133',
              method: 'prvTaskExitError',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/riscv/port.c',
              args: [],
            },
          ],
        },
      },
      {
        threadId: '3',
        current: false,
        TCB: 1070140416,
        result: {
          faultInfo: {
            coreId: 3,
            programCounter: {
              addr: 1077441290,
              location: {
                regAddr: '0x4038730a',
                lineNumber: '308',
                method: 'vPortClearInterruptMask',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/riscv/port.c',
                args: [
                  {
                    name: 'mask',
                    type: 'int',
                    value: '1',
                  },
                ],
              },
            },
            faultCode: undefined,
          },
          regs: {
            zero: 0,
            ra: 1077440134,
            sp: 1070140256,
            gp: 1070119424,
            tp: 1070097444,
            t0: 0,
            t1: 0,
            t2: 0,
            fp: 1070130912,
            s1: 1,
            a0: 1,
            a1: 1,
            a2: 1,
            a3: 1,
            a4: 1070130884,
            a5: 1611407360,
            a6: 0,
            a7: 0,
            s2: 0,
            s3: 4041088542,
            s4: 16777215,
            s5: 1070129152,
            s6: 0,
            s7: 0,
            s8: 0,
            s9: 0,
            s10: 0,
            s11: 0,
            t3: 0,
            t4: 0,
            t5: 0,
            t6: 0,
            pc: 1077441290,
          },
          stacktraceLines: [
            {
              regAddr: '0x4038730a',
              lineNumber: '308',
              method: 'vPortClearInterruptMask',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/riscv/port.c',
              args: [
                {
                  name: 'mask',
                  type: 'int',
                  value: '1',
                },
              ],
            },
            {
              regAddr: '0x4038732a',
              lineNumber: '259',
              method: 'vPortExitCritical',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/riscv/port.c',
              args: [],
            },
            {
              regAddr: '0x40386e86',
              lineNumber: '5513',
              method: 'ulTaskGenericNotifyTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'uxIndexToWait',
                  type: 'UBaseType_t',
                  value: '0',
                },
                {
                  name: 'uxIndexToWait@entry',
                  type: 'UBaseType_t',
                  value: '0',
                },
                {
                  name: 'xClearCountOnExit',
                  type: 'BaseType_t',
                  value: '1',
                },
                {
                  name: 'xClearCountOnExit@entry',
                  type: 'BaseType_t',
                  value: '1',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '4294967295',
                },
                {
                  name: 'xTicksToWait@entry',
                  type: 'TickType_t',
                  value: '4294967295',
                },
              ],
            },
            {
              regAddr: '0x4200ff80',
              lineNumber: '420',
              method: 'timer_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_timer/src/esp_timer.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x4038729c',
              lineNumber: '133',
              method: 'prvTaskExitError',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/riscv/port.c',
              args: [],
            },
          ],
        },
      },
    ],
  },
  {
    coredumpFolderName: 'crash_test',
    fqbn: 'esp32:esp32:esp32da',
    expected: [
      {
        threadId: '1',
        current: true,
        TCB: 1073447304,
        result: {
          faultInfo: {
            coreId: 1,
            programCounter: {
              addr: 1074598923,
              location: {
                regAddr: '0x400d140b',
                lineNumber: '12',
                method: 'setup',
                file: 'src/main.cpp',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074598923,
            ar0: 2148348045,
            ar1: 1073422944,
            ar2: 0,
            ar3: 0,
            ar4: 20,
            ar5: 4,
            ar6: 1073447304,
            ar7: 2147483649,
            ar8: 2148340744,
            ar9: 1073422912,
            ar10: 100,
            ar11: 22,
            ar12: 120,
            ar13: 57600,
            ar14: 1,
            ar15: 1073470312,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 1074291761,
            lend: 1074291777,
            lcount: 4294967295,
            sar: 29,
            windowbase: 0,
            windowstart: 0,
            ps: 395296,
            a0: 2148348045,
            a1: 1073422944,
            a2: 0,
            a3: 0,
            a4: 20,
            a5: 4,
            a6: 1073447304,
            a7: 2147483649,
            a8: 2148340744,
            a9: 1073422912,
            a10: 100,
            a11: 22,
            a12: 120,
            a13: 57600,
            a14: 1,
            a15: 1073470312,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 8,
          },
          stacktraceLines: [
            {
              regAddr: '0x400d140b',
              lineNumber: '12',
              method: 'setup',
              file: 'src/main.cpp',
              args: [],
            },
            {
              regAddr: '0x400d308d',
              lineNumber: '42',
              method: 'loopTask',
              file: '/Users/kittaakos/.platformio/packages/framework-arduinoespressif32/cores/esp32/main.cpp',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '0x0',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '2',
        current: false,
        TCB: 1073466864,
        result: {
          faultInfo: {
            coreId: 2,
            programCounter: {
              addr: 1074728806,
              location: {
                regAddr: '0x400f0f66',
                lineNumber: '855',
                method: 'esp_pm_impl_waiti',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074728806,
            ar0: 2148374841,
            ar1: 1073466640,
            ar2: 0,
            ar3: 393251,
            ar4: 393251,
            ar5: 2147483648,
            ar6: 0,
            ar7: 4194303,
            ar8: 1073488276,
            ar9: 1,
            ar10: 1,
            ar11: 1073465824,
            ar12: 32,
            ar13: 2147483648,
            ar14: 0,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 0,
            windowbase: 0,
            windowstart: 0,
            ps: 395808,
            a0: 2148374841,
            a1: 1073466640,
            a2: 0,
            a3: 393251,
            a4: 393251,
            a5: 2147483648,
            a6: 0,
            a7: 4194303,
            a8: 1073488276,
            a9: 1,
            a10: 1,
            a11: 1073465824,
            a12: 32,
            a13: 2147483648,
            a14: 0,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 10,
          },
          stacktraceLines: [
            {
              regAddr: '0x400f0f66',
              lineNumber: '855',
              method: 'esp_pm_impl_waiti',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
              args: [],
            },
            {
              regAddr: '0x400d9939',
              lineNumber: '63',
              method: 'esp_vApplicationIdleHook',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/freertos_hooks.c',
              args: [],
            },
            {
              regAddr: '0x400892e0',
              lineNumber: '4099',
              method: 'prvIdleTask',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '3',
        current: false,
        TCB: 1073465464,
        result: {
          faultInfo: {
            coreId: 3,
            programCounter: {
              addr: 1074728806,
              location: {
                regAddr: '0x400f0f66',
                lineNumber: '855',
                method: 'esp_pm_impl_waiti',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074728806,
            ar0: 2148374841,
            ar1: 1073465248,
            ar2: 0,
            ar3: 1074288440,
            ar4: 394528,
            ar5: 1073463552,
            ar6: 8123192,
            ar7: 4194303,
            ar8: 2148373818,
            ar9: 1073465200,
            ar10: 0,
            ar11: 1073476404,
            ar12: 1073476404,
            ar13: 0,
            ar14: 394528,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 29,
            windowbase: 0,
            windowstart: 0,
            ps: 394528,
            a0: 2148374841,
            a1: 1073465248,
            a2: 0,
            a3: 1074288440,
            a4: 394528,
            a5: 1073463552,
            a6: 8123192,
            a7: 4194303,
            a8: 2148373818,
            a9: 1073465200,
            a10: 0,
            a11: 1073476404,
            a12: 1073476404,
            a13: 0,
            a14: 394528,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 5,
          },
          stacktraceLines: [
            {
              regAddr: '0x400f0f66',
              lineNumber: '855',
              method: 'esp_pm_impl_waiti',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
              args: [],
            },
            {
              regAddr: '0x400d9939',
              lineNumber: '63',
              method: 'esp_vApplicationIdleHook',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/freertos_hooks.c',
              args: [],
            },
            {
              regAddr: '0x400892e0',
              lineNumber: '4099',
              method: 'prvIdleTask',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '4',
        current: false,
        TCB: 1073443880,
        result: {
          faultInfo: {
            coreId: 4,
            programCounter: {
              addr: 1074279312,
              location: {
                regAddr: '0x40083390',
                lineNumber: '145',
                method: 'esp_crosscore_int_send_yield',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
                args: [
                  {
                    name: 'core_id',
                    type: 'int',
                    value: '0',
                  },
                ],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074279312,
            ar0: 2148044576,
            ar1: 1073443632,
            ar2: 0,
            ar3: 4294967295,
            ar4: 1073442816,
            ar5: 1073442756,
            ar6: 1073442776,
            ar7: 0,
            ar8: 2148021136,
            ar9: 1073443600,
            ar10: 1072693468,
            ar11: 1,
            ar12: 1073470648,
            ar13: 393251,
            ar14: 393251,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 1,
            windowbase: 0,
            windowstart: 0,
            ps: 393248,
            a0: 2148044576,
            a1: 1073443632,
            a2: 0,
            a3: 4294967295,
            a4: 1073442816,
            a5: 1073442756,
            a6: 1073442776,
            a7: 0,
            a8: 2148021136,
            a9: 1073443600,
            a10: 1072693468,
            a11: 1,
            a12: 1073470648,
            a13: 393251,
            a14: 393251,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 0,
          },
          stacktraceLines: [
            {
              regAddr: '0x40083390',
              lineNumber: '145',
              method: 'esp_crosscore_int_send_yield',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
              args: [
                {
                  name: 'core_id',
                  type: 'int',
                  value: '0',
                },
              ],
            },
            {
              regAddr: '0x40088f20',
              lineNumber: '39',
              method: 'xQueueSemaphoreTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/hal/esp32/include/hal/cpu_ll.h',
              args: [
                {
                  name: 'xQueue',
                  type: 'QueueHandle_t',
                  value: '0x3ffb6fb4',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x40084dcf',
              lineNumber: '54',
              method: 'ipc_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_ipc/src/esp_ipc.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '5',
        current: false,
        TCB: 1073446240,
        result: {
          faultInfo: {
            coreId: 5,
            programCounter: {
              addr: 1073790960,
              location: {
                regAddr: '0x4000bff0',
                lineNumber: '??',
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1073790960,
            ar0: 2148052888,
            ar1: 1073458720,
            ar2: 0,
            ar3: 393251,
            ar4: 393248,
            ar5: 2147483648,
            ar6: 8123192,
            ar7: 4194303,
            ar8: 1,
            ar9: 1073458672,
            ar10: 1073488256,
            ar11: 1073488256,
            ar12: 0,
            ar13: 393251,
            ar14: 393251,
            ar15: 1,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 0,
            windowbase: 0,
            windowstart: 0,
            ps: 393248,
            a0: 2148052888,
            a1: 1073458720,
            a2: 0,
            a3: 393251,
            a4: 393248,
            a5: 2147483648,
            a6: 8123192,
            a7: 4194303,
            a8: 1,
            a9: 1073458672,
            a10: 1073488256,
            a11: 1073488256,
            a12: 0,
            a13: 393251,
            a14: 393251,
            a15: 1,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 0,
          },
          stacktraceLines: [
            {
              regAddr: '0x4000bff0',
              lineNumber: '??',
            },
            {
              regAddr: '0x4008af98',
              lineNumber: '571',
              method: 'vPortClearInterruptMaskFromISR',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/xtensa/include/freertos/portmacro.h',
              args: [],
            },
            {
              regAddr: '0x4008af98',
              lineNumber: '332',
              method: 'vPortExitCritical',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/xtensa/port.c',
              args: [
                {
                  name: 'mux',
                  type: 'portMUX_TYPE *',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x4008a679',
              lineNumber: '5513',
              method: 'ulTaskGenericNotifyTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'uxIndexToWait',
                  type: 'UBaseType_t',
                  value: '<optimized out>',
                },
                {
                  name: 'xClearCountOnExit',
                  type: 'BaseType_t',
                  value: '1',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '4294967295',
                },
              ],
            },
            {
              regAddr: '0x400dd20f',
              lineNumber: '420',
              method: 'timer_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_timer/src/esp_timer.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '6',
        current: false,
        TCB: 1073445580,
        result: {
          faultInfo: {
            coreId: 6,
            programCounter: {
              addr: 1074279312,
              location: {
                regAddr: '0x40083390',
                lineNumber: '145',
                method: 'esp_crosscore_int_send_yield',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
                args: [
                  {
                    name: 'core_id',
                    type: 'int',
                    value: '1',
                  },
                ],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074279312,
            ar0: 2148044576,
            ar1: 1073445328,
            ar2: 1,
            ar3: 4294967295,
            ar4: 1073444516,
            ar5: 1073444456,
            ar6: 1073444476,
            ar7: 0,
            ar8: 2148021136,
            ar9: 1073445296,
            ar10: 1072693472,
            ar11: 1,
            ar12: 1073470648,
            ar13: 393507,
            ar14: 393507,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 1,
            windowbase: 0,
            windowstart: 0,
            ps: 393504,
            a0: 2148044576,
            a1: 1073445328,
            a2: 1,
            a3: 4294967295,
            a4: 1073444516,
            a5: 1073444456,
            a6: 1073444476,
            a7: 0,
            a8: 2148021136,
            a9: 1073445296,
            a10: 1072693472,
            a11: 1,
            a12: 1073470648,
            a13: 393507,
            a14: 393507,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 1,
          },
          stacktraceLines: [
            {
              regAddr: '0x40083390',
              lineNumber: '145',
              method: 'esp_crosscore_int_send_yield',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
              args: [
                {
                  name: 'core_id',
                  type: 'int',
                  value: '1',
                },
              ],
            },
            {
              regAddr: '0x40088f20',
              lineNumber: '39',
              method: 'xQueueSemaphoreTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/hal/esp32/include/hal/cpu_ll.h',
              args: [
                {
                  name: 'xQueue',
                  type: 'QueueHandle_t',
                  value: '0x3ffb7658',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x40084dcf',
              lineNumber: '54',
              method: 'ipc_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_ipc/src/esp_ipc.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
    ],
  },
  {
    coredumpFolderName: 'esp32backtracetest',
    fqbn: 'esp32:esp32:esp32da',
    expected: [
      {
        threadId: '1',
        current: true,
        TCB: 1073447304,
        result: {
          faultInfo: {
            coreId: 1,
            programCounter: {
              addr: 1074598953,
              location: {
                regAddr: '0x400d1429',
                lineNumber: '9',
                method: 'functionC',
                file: 'src/module2.cpp',
                args: [
                  {
                    name: 'num',
                    type: 'int',
                    value: '42',
                  },
                ],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074598953,
            ar0: 2148340801,
            ar1: 1073422832,
            ar2: 42,
            ar3: 34,
            ar4: 32,
            ar5: 65280,
            ar6: 16711680,
            ar7: 4278190080,
            ar8: 0,
            ar9: 1073422800,
            ar10: 44,
            ar11: 42,
            ar12: 34,
            ar13: 65280,
            ar14: 16711680,
            ar15: 4278190080,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 1074291761,
            lend: 1074291777,
            lcount: 4294967295,
            sar: 29,
            windowbase: 0,
            windowstart: 0,
            ps: 396832,
            a0: 2148340801,
            a1: 1073422832,
            a2: 42,
            a3: 34,
            a4: 32,
            a5: 65280,
            a6: 16711680,
            a7: 4278190080,
            a8: 0,
            a9: 1073422800,
            a10: 44,
            a11: 42,
            a12: 34,
            a13: 65280,
            a14: 16711680,
            a15: 4278190080,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 14,
          },
          stacktraceLines: [
            {
              regAddr: '0x400d1429',
              lineNumber: '9',
              method: 'functionC',
              file: 'src/module2.cpp',
              args: [
                {
                  name: 'num',
                  type: 'int',
                  value: '42',
                },
              ],
            },
            {
              regAddr: '0x400d1441',
              lineNumber: '14',
              method: 'functionB',
              file: 'src/module2.cpp',
              args: [
                {
                  name: 'ptr',
                  type: 'int *',
                  value: '0x3ffb223c',
                },
              ],
            },
            {
              regAddr: '0x400d1415',
              lineNumber: '7',
              method: 'functionA',
              file: 'src/module1.cpp',
              args: [
                {
                  name: 'value',
                  type: 'int',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x400d13fc',
              lineNumber: '9',
              method: 'setup',
              file: 'src/main.cpp',
              args: [],
            },
            {
              regAddr: '0x400d30b5',
              lineNumber: '42',
              method: 'loopTask',
              file: '/Users/kittaakos/.platformio/packages/framework-arduinoespressif32/cores/esp32/main.cpp',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '0x0',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '2',
        current: false,
        TCB: 1073465464,
        result: {
          faultInfo: {
            coreId: 2,
            programCounter: {
              addr: 1074728846,
              location: {
                regAddr: '0x400f0f8e',
                lineNumber: '855',
                method: 'esp_pm_impl_waiti',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074728846,
            ar0: 2148374881,
            ar1: 1073465248,
            ar2: 0,
            ar3: 1074288440,
            ar4: 393248,
            ar5: 2147483648,
            ar6: 8123192,
            ar7: 4194303,
            ar8: 2148373858,
            ar9: 1073465200,
            ar10: 0,
            ar11: 2147483649,
            ar12: 2148052888,
            ar13: 1073464992,
            ar14: 3,
            ar15: 393251,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 29,
            windowbase: 0,
            windowstart: 0,
            ps: 394528,
            a0: 2148374881,
            a1: 1073465248,
            a2: 0,
            a3: 1074288440,
            a4: 393248,
            a5: 2147483648,
            a6: 8123192,
            a7: 4194303,
            a8: 2148373858,
            a9: 1073465200,
            a10: 0,
            a11: 2147483649,
            a12: 2148052888,
            a13: 1073464992,
            a14: 3,
            a15: 393251,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 5,
          },
          stacktraceLines: [
            {
              regAddr: '0x400f0f8e',
              lineNumber: '855',
              method: 'esp_pm_impl_waiti',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
              args: [],
            },
            {
              regAddr: '0x400d9961',
              lineNumber: '63',
              method: 'esp_vApplicationIdleHook',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/freertos_hooks.c',
              args: [],
            },
            {
              regAddr: '0x400892e0',
              lineNumber: '4099',
              method: 'prvIdleTask',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '3',
        current: false,
        TCB: 1073466864,
        result: {
          faultInfo: {
            coreId: 3,
            programCounter: {
              addr: 1074728846,
              location: {
                regAddr: '0x400f0f8e',
                lineNumber: '855',
                method: 'esp_pm_impl_waiti',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
                args: [],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074728846,
            ar0: 2148374881,
            ar1: 1073466640,
            ar2: 0,
            ar3: 393251,
            ar4: 393251,
            ar5: 2147483648,
            ar6: 0,
            ar7: 4194303,
            ar8: 1073488276,
            ar9: 1,
            ar10: 1,
            ar11: 1073465824,
            ar12: 32,
            ar13: 2147483648,
            ar14: 0,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 0,
            windowbase: 0,
            windowstart: 0,
            ps: 395808,
            a0: 2148374881,
            a1: 1073466640,
            a2: 0,
            a3: 393251,
            a4: 393251,
            a5: 2147483648,
            a6: 0,
            a7: 4194303,
            a8: 1073488276,
            a9: 1,
            a10: 1,
            a11: 1073465824,
            a12: 32,
            a13: 2147483648,
            a14: 0,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 10,
          },
          stacktraceLines: [
            {
              regAddr: '0x400f0f8e',
              lineNumber: '855',
              method: 'esp_pm_impl_waiti',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_pm/pm_impl.c',
              args: [],
            },
            {
              regAddr: '0x400d9961',
              lineNumber: '63',
              method: 'esp_vApplicationIdleHook',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/freertos_hooks.c',
              args: [],
            },
            {
              regAddr: '0x400892e0',
              lineNumber: '4099',
              method: 'prvIdleTask',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'pvParameters',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '4',
        current: false,
        TCB: 1073443880,
        result: {
          faultInfo: {
            coreId: 4,
            programCounter: {
              addr: 1074279312,
              location: {
                regAddr: '0x40083390',
                lineNumber: '145',
                method: 'esp_crosscore_int_send_yield',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
                args: [
                  {
                    name: 'core_id',
                    type: 'int',
                    value: '0',
                  },
                ],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074279312,
            ar0: 2148044576,
            ar1: 1073443632,
            ar2: 0,
            ar3: 4294967295,
            ar4: 1073442816,
            ar5: 1073442756,
            ar6: 1073442776,
            ar7: 0,
            ar8: 2148021136,
            ar9: 1073443600,
            ar10: 1072693468,
            ar11: 1,
            ar12: 1073470648,
            ar13: 393251,
            ar14: 393251,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 1,
            windowbase: 0,
            windowstart: 0,
            ps: 393248,
            a0: 2148044576,
            a1: 1073443632,
            a2: 0,
            a3: 4294967295,
            a4: 1073442816,
            a5: 1073442756,
            a6: 1073442776,
            a7: 0,
            a8: 2148021136,
            a9: 1073443600,
            a10: 1072693468,
            a11: 1,
            a12: 1073470648,
            a13: 393251,
            a14: 393251,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 0,
          },
          stacktraceLines: [
            {
              regAddr: '0x40083390',
              lineNumber: '145',
              method: 'esp_crosscore_int_send_yield',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
              args: [
                {
                  name: 'core_id',
                  type: 'int',
                  value: '0',
                },
              ],
            },
            {
              regAddr: '0x40088f20',
              lineNumber: '39',
              method: 'xQueueSemaphoreTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/hal/esp32/include/hal/cpu_ll.h',
              args: [
                {
                  name: 'xQueue',
                  type: 'QueueHandle_t',
                  value: '0x3ffb6fb4',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x40084dcf',
              lineNumber: '54',
              method: 'ipc_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_ipc/src/esp_ipc.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '5',
        current: false,
        TCB: 1073446240,
        result: {
          faultInfo: {
            coreId: 5,
            programCounter: {
              addr: 1073790960,
              location: {
                regAddr: '0x4000bff0',
                lineNumber: '??',
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1073790960,
            ar0: 2148052888,
            ar1: 1073458720,
            ar2: 0,
            ar3: 393251,
            ar4: 393248,
            ar5: 2147483648,
            ar6: 8123192,
            ar7: 4194303,
            ar8: 1,
            ar9: 1073458672,
            ar10: 1073488256,
            ar11: 1073488256,
            ar12: 0,
            ar13: 393251,
            ar14: 393251,
            ar15: 1,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 0,
            windowbase: 0,
            windowstart: 0,
            ps: 393248,
            a0: 2148052888,
            a1: 1073458720,
            a2: 0,
            a3: 393251,
            a4: 393248,
            a5: 2147483648,
            a6: 8123192,
            a7: 4194303,
            a8: 1,
            a9: 1073458672,
            a10: 1073488256,
            a11: 1073488256,
            a12: 0,
            a13: 393251,
            a14: 393251,
            a15: 1,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 0,
          },
          stacktraceLines: [
            {
              regAddr: '0x4000bff0',
              lineNumber: '??',
            },
            {
              regAddr: '0x4008af98',
              lineNumber: '571',
              method: 'vPortClearInterruptMaskFromISR',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/xtensa/include/freertos/portmacro.h',
              args: [],
            },
            {
              regAddr: '0x4008af98',
              lineNumber: '332',
              method: 'vPortExitCritical',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/port/xtensa/port.c',
              args: [
                {
                  name: 'mux',
                  type: 'portMUX_TYPE *',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x4008a679',
              lineNumber: '5513',
              method: 'ulTaskGenericNotifyTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/freertos/tasks.c',
              args: [
                {
                  name: 'uxIndexToWait',
                  type: 'UBaseType_t',
                  value: '<optimized out>',
                },
                {
                  name: 'xClearCountOnExit',
                  type: 'BaseType_t',
                  value: '1',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '4294967295',
                },
              ],
            },
            {
              regAddr: '0x400dd237',
              lineNumber: '420',
              method: 'timer_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_timer/src/esp_timer.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
      {
        threadId: '6',
        current: false,
        TCB: 1073445580,
        result: {
          faultInfo: {
            coreId: 6,
            programCounter: {
              addr: 1074279312,
              location: {
                regAddr: '0x40083390',
                lineNumber: '145',
                method: 'esp_crosscore_int_send_yield',
                file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
                args: [
                  {
                    name: 'core_id',
                    type: 'int',
                    value: '1',
                  },
                ],
              },
            },
            faultCode: undefined,
          },
          regs: {
            pc: 1074279312,
            ar0: 2148044576,
            ar1: 1073445328,
            ar2: 1,
            ar3: 4294967295,
            ar4: 1073444516,
            ar5: 1073444456,
            ar6: 1073444476,
            ar7: 0,
            ar8: 2148021136,
            ar9: 1073445296,
            ar10: 1072693472,
            ar11: 1,
            ar12: 1073470648,
            ar13: 393507,
            ar14: 393507,
            ar15: 0,
            ar16: 0,
            ar17: 0,
            ar18: 0,
            ar19: 0,
            ar20: 0,
            ar21: 0,
            ar22: 0,
            ar23: 0,
            ar24: 0,
            ar25: 0,
            ar26: 0,
            ar27: 0,
            ar28: 0,
            ar29: 0,
            ar30: 0,
            ar31: 0,
            ar32: 0,
            ar33: 0,
            ar34: 0,
            ar35: 0,
            ar36: 0,
            ar37: 0,
            ar38: 0,
            ar39: 0,
            ar40: 0,
            ar41: 0,
            ar42: 0,
            ar43: 0,
            ar44: 0,
            ar45: 0,
            ar46: 0,
            ar47: 0,
            ar48: 0,
            ar49: 0,
            ar50: 0,
            ar51: 0,
            ar52: 0,
            ar53: 0,
            ar54: 0,
            ar55: 0,
            ar56: 0,
            ar57: 0,
            ar58: 0,
            ar59: 0,
            ar60: 0,
            ar61: 0,
            ar62: 0,
            ar63: 0,
            lbeg: 0,
            lend: 0,
            lcount: 0,
            sar: 1,
            windowbase: 0,
            windowstart: 0,
            ps: 393504,
            a0: 2148044576,
            a1: 1073445328,
            a2: 1,
            a3: 4294967295,
            a4: 1073444516,
            a5: 1073444456,
            a6: 1073444476,
            a7: 0,
            a8: 2148021136,
            a9: 1073445296,
            a10: 1072693472,
            a11: 1,
            a12: 1073470648,
            a13: 393507,
            a14: 393507,
            a15: 0,
            psintlevel: 0,
            psum: 1,
            pswoe: 1,
            psexcm: 0,
            pscallinc: 2,
            psowb: 1,
          },
          stacktraceLines: [
            {
              regAddr: '0x40083390',
              lineNumber: '145',
              method: 'esp_crosscore_int_send_yield',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_system/crosscore_int.c',
              args: [
                {
                  name: 'core_id',
                  type: 'int',
                  value: '1',
                },
              ],
            },
            {
              regAddr: '0x40088f20',
              lineNumber: '39',
              method: 'xQueueSemaphoreTake',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/hal/esp32/include/hal/cpu_ll.h',
              args: [
                {
                  name: 'xQueue',
                  type: 'QueueHandle_t',
                  value: '0x3ffb7658',
                },
                {
                  name: 'xTicksToWait',
                  type: 'TickType_t',
                  value: '<optimized out>',
                },
              ],
            },
            {
              regAddr: '0x40084dcf',
              lineNumber: '54',
              method: 'ipc_task',
              file: '/home/runner/work/esp32-arduino-lib-builder/esp32-arduino-lib-builder/esp-idf/components/esp_ipc/src/esp_ipc.c',
              args: [
                {
                  name: 'arg',
                  type: 'void *',
                  value: '<optimized out>',
                },
              ],
            },
          ],
        },
      },
    ],
  },
]

describe('coredump (slow)', () => {
  /** @type {import('./decode.slow-test.js').TestEnv} */
  let testEnv

  beforeAll(() => {
    // @ts-ignore
    testEnv = inject('testEnv')
    expect(testEnv).toBeDefined()
  })

  describe('decodeCoredump', () => {
    beforeEach(() => {
      vi.clearAllMocks()
    })

    decodeCoredumpTestParams.map((params) =>
      it(`should decode coredump from ${params.coredumpFolderName} for ${params.fqbn}`, async () => {
        const fqbn = new FQBN(params.fqbn)
        const boardId = fqbn.boardId

        const coredumpPath = path.join(
          coredumpsPath,
          boardId,
          params.coredumpFolderName,
          'coredump.elf'
        )
        const elfPath = path.join(
          coredumpsPath,
          boardId,
          params.coredumpFolderName,
          'firmware.elf'
        )
        const toolPath = await findToolPath({
          arduinoCliPath: testEnv.cliContext.cliPath,
          fqbn,
          arduinoCliConfig: testEnv.toolsEnvs['cli'].cliConfigPath,
        })

        const actual = await decodeCoredump({
          targetArch: isRiscvFQBN(fqbn) ? fqbn.boardId : 'xtensa',
          toolPath,
          elfPath,
          coredumpPath,
        })

        expect(actual).toEqual(expect.arrayContaining(params.expected))
      })
    )
  })
})
